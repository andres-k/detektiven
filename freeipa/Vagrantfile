ENV["LC_ALL"] = "en_US.UTF-8"

$provision_script = <<SCRIPT

XENIAL=$(lsb_release -c | cut -f2)
if [ "$XENIAL" != "xenial" ]; then
    echo "sorry, tested only with xenial ;(";
    exit;
fi

IP=$1
IP="192.168.10.2"

echo "$IP" > /tmp/provision.log

echo "127.0.0.1 localhost" > /etc/hosts
echo "$IP ipa.example.org ipa" >> /etc/hosts

export DEBIAN_FRONTEND=noninteractive

curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash - >> /tmp/provision.log

apt-get -y install nodejs >> /tmp/provision.log
export NODE_PATH=/usr/lib/node_modules/
apt-get -y install build-essential >> /tmp/provision.log
apt-get -y install freeipa-server >> /tmp/provision.log


DirectoryManagerpassword=$(< /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c8)
IPAadminpassword="$DirectoryManagerpassword"

echo -en "\n\n\n\n$DirectoryManagerpassword\n$DirectoryManagerpassword\n$IPAadminpassword\n$IPAadminpassword\nyes\n" | ipa-server-install
echo -en "$IPAadminpassword" | kinit admin
ipa user-find admin
echo "admin password is $IPAadminpassword"

# create read only bind user to search ldap
#A. First, make that dedicated ldap auth user in FreeIPA, for example, username: readonly with a good password.
ipa user-add webeid --first=web --last=eid  --homedir=/dev/null --shell=/sbin/nologin
echo -en "kalakala\nkalakala\n" |ipa passwd webeid
#B. Next, go to IPA Server > Role Based Access Control > Permission
#C. There, create a new Permission called Read Only LDAP Auth and select Granted rights: [x] read [x] search [x] compare
ipa permission-add ReadOnlyLDAP  --filter='(!(cn=admins))'  --right=read --right=search --right=compare
#D. Next, create a Privilege called Read Only LDAP Auth, and add the Permission just created.
ipa privilege-add ReadOnlyLDAP
ipa privilege-add-permission ReadOnlyLDAP --permissions=ReadOnlyLDAP
#E. Finally, create a Role Read Only LDAP Auth, and add the Privilege Read Only LDAP Auth.
ipa role-add ReadOnlyLDAP
ipa role-add-privilege ReadOnlyLDAP --privileges=ReadOnlyLDAP
#F. And lastly, add the user readonly to that Role.
ipa role-add-member ReadOnlyLDAP --users=webeid

ipa role-show ReadOnlyLDAP
ipa user-find webeid
ldapsearch -x -D "uid=webeid,cn=users,cn=accounts,dc=example,dc=org" -w kalakala -h 192.168.10.2 -b "cn=accounts,dc=example,dc=org" -s sub 'uid=webeid'

#create fixture user
ipa user-add hillar --first=HILLAR --last=AARELAID --employeenumber=36712316013 --email=hillar.aarelaid@eesti.ee --certificate=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;
ipa user-mod hillar --addattr=mail=hillar.aarelaid@webeid.com;
ipa user-mod hillar --sshpubkey=AAAAB3NzaC1yc2EAAAADAQABAAABAQCZoBOnNscP+wMaErl/lJckLqAb3nA+osjxrYYaKbyIcuq08WEBjsn1Tm7QZyHYhjhIIm14YUsA0KOJtgrH4diCwmg6I8+wdlK6Bf9vE4VPz3DrQT9wFRR0Dyo6jXexipkCZqtCRzW1EFRi/idY/EmAn/KrC3zrIiwQPQc9GuYIqcq1luLAvdukJea8eufx/wOzL9EGADSV9ILboaQP1Xm39LRug5mFsG8JX1uUU0K7z7usIuxPpfmmFUQimIEbGF6NzbQ5AKbkdKazO1HLskHV3HvqCj3bos0uCtMWrKcd+AC3XEQ0vNNswh1mrs3srnfpweJpW+P1daqAXRYwPJ4h,AAAAB3NzaC1yc2EAAAADAQABAAABAQCVGogSAzeTTXoARqvY/yvC+rtD3pCjBdeqOtfkESv4j3RnSZMmIXC7MW9tqf7FBgJK5je9zlyhhtMGy/qhAOmsm4SmyeQkZG6jz6xXrZ8HC+jWgnM5cYaKqFR1QyXW9M2pHwZgcU9gXA79Qo6+b3PO7DduqXM/foS7xHETvzr6PHj5wdP7erzNiBRQhROc2LJKA3lnqrB/XZltIC89DAT0+KelWnaM46W+Ok6DhqoQ/yEabeiU3yfjA3wpScV60e91wdJLVrzHqI3qZCL8GTCPs/viiE2VTYNsM/1btsnv06vli7lJwfmtytIuye/3Z0VzDB0OckXPMVI//GmnKz47;

# save temporary password
echo "$IPAadminpassword" > /root/ipapass.txt
echo "admin password is $IPAadminpassword"

SCRIPT

Vagrant.configure(2) do |config|

  config.vm.provider "virtualbox"
  config.vm.hostname= "ipa.example.org"

  config.vm.synced_folder ".", "/vagrant", disabled: true
  config.vm.box = 'ubuntu/xenial64'

  config.vm.provider :virtualbox do |vb,override|
     vb.customize ["modifyvm", :id, "--memory", "2048"]
     vb.customize ["modifyvm", :id, "--cpus", "1"]
     override.vm.network :private_network, ip: "192.168.10.2"
     override.vm.synced_folder ".", "/vagrant", disabled: false
   end

   config.vm.provider :aws do |aws, override|
     aws.access_key_id = ENV['AWS_KEY']
     aws.secret_access_key = ENV['AWS_SECRET']
     aws.keypair_name = ENV['AWS_KEYNAME']
     aws.instance_type = "t2.micro"
     aws.region = "us-east-1"
     aws.ami = "ami-772aa961"
     override.ssh.username = 'ubuntu'
     override.ssh.private_key_path = ENV['AWS_KEYPATH']

   end

   config.vm.provision "shell", inline: $provision_script

end
